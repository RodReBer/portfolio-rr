---
import { isValidEmail } from "../services/contactValidate";
import { Resend } from "resend";

const resend = new Resend(import.meta.env.RESEND_API_KEY);

const errors = { Name: "", Email: "", Subject: "", Message: "", general: "" };
let formData = { Name: "", Email: "", Subject: "", Message: "" };
let successMessage = "";

if (Astro.request.method === "POST") {
  Object.keys(errors).forEach((key) => (errors[key] = ""));

  try {
    const data = await Astro.request.formData();
    formData = {
      Name: data.get("Name")?.toString().trim() ?? "",
      Email: data.get("Email")?.toString().trim() ?? "",
      Subject: data.get("Subject")?.toString().trim() ?? "",
      Message: data.get("Message")?.toString().trim() ?? "",
    };

    // Validaciones
    const nombre = formData.Name.toLowerCase();
    if (formData.Name.length < 1) {
      errors.Name = "Please enter your name.";
    } else if (
      nombre.includes("wic") ||
      nombre.includes("myname") ||
      nombre.includes("testuser") ||
      nombre.includes("hello") ||
      nombre.includes("alice") ||
      nombre.includes("john")
    ) {
      errors.Name = "Invalid name.";
    }

    if (!isValidEmail(formData.Email)) {
      errors.Email = "Please provide a valid email address.";
    }

    if (formData.Subject.length < 1) {
      errors.Subject = "Please enter a subject.";
    }

    if (formData.Message.length < 1) {
      errors.Message = "Your message cannot be empty.";
    }

    const hasErrors = Object.values(errors).some((msg) => msg);

    if (!hasErrors) {
      // Enviar correo al admin
      await resend.emails.send({
        from: "onboarding@resend.dev",
        to: "rodrigorey2005@gmail.com",
        subject: `New Contact Form Submission: ${formData.Subject}`,
        html: `
          <h2>New Message from ${formData.Name}</h2>
          <p><strong>Email:</strong> ${formData.Email}</p>
          <p><strong>Subject:</strong> ${formData.Subject}</p>
          <p><strong>Message:</strong><br>${formData.Message}</p>
        `,
      });

      // Correo de agradecimiento
      await resend.emails.send({
        from: "correo@rodrigorey.info",
        to: formData.Email,
        subject: "Thank you for your message",
        html: `
          <h2>Thanks, ${formData.Name}!</h2>
          <p>We got your message. We'll reply soon!</p>
        `,
      });

      successMessage = "Your message has been sent successfully! Please check your email.";
      formData = { Name: "", Email: "", Subject: "", Message: "" };
    }
  } catch (err) {
    console.error(err);
    errors.general = "An unexpected error occurred. Please try again.";
  }
}
---

<form class="max-w-md mx-auto" method="POST">
  {successMessage && (
    <div class="mb-4 p-4 bg-green-100 text-green-700 rounded-md">
      {successMessage}
    </div>
  )}

  {errors.general && (
    <div class="mb-4 p-4 bg-red-100 text-red-700 rounded-md">
      {errors.general}
    </div>
  )}

  <div class="mb-5">
    <label for="Name" class="block mb-1">Name</label>
    <input type="text" id="Name" name="Name" value={formData.Name} required class="w-full border px-3 py-2" />
    {errors.Name && <p class="text-red-500 text-sm">{errors.Name}</p>}
  </div>

  <div class="mb-5">
    <label for="Email" class="block mb-1">Email</label>
    <input type="email" id="Email" name="Email" value={formData.Email} required class="w-full border px-3 py-2" />
    {errors.Email && <p class="text-red-500 text-sm">{errors.Email}</p>}
  </div>

  <div class="mb-5">
    <label for="Subject" class="block mb-1">Subject</label>
    <input type="text" id="Subject" name="Subject" value={formData.Subject} required class="w-full border px-3 py-2" />
    {errors.Subject && <p class="text-red-500 text-sm">{errors.Subject}</p>}
  </div>

  <div class="mb-5">
    <label for="Message" class="block mb-1">Message</label>
    <textarea id="Message" name="Message" required class="w-full border px-3 py-2" rows="5">{formData.Message}</textarea>
    {errors.Message && <p class="text-red-500 text-sm">{errors.Message}</p>}
  </div>

  <button type="submit" class="bg-violet-600 text-white px-4 py-2 rounded">Send</button>
</form>
